---
layout: post
date: 2016-03-12
author: ä»˜äºšå†›
categories: wifi 
---
<div id="content">
<h1 class="title">WiFiæ¡ˆä¾‹1 &#x2013; Miracastæ— æ³•è¿æ¥</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">é—®é¢˜æè¿°</a></li>
<li><a href="#sec-2">é—®é¢˜åˆ†æ</a></li>
<li><a href="#sec-3">è§£å†³æ–¹æ³•</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">é—®é¢˜æè¿°</h2>
<div class="outline-text-2" id="text-1">
<p>
å®¢æˆ·å¹³å°çš„ç½‘å¡ä»ä¸€å®¶å‚å•†çš„èŠ¯ç‰‡æ›´æ¢ä¸ºå¦ä¸€å®¶çš„èŠ¯ç‰‡ï¼Œç»“æœå‡ºç°WiFi
Miracastæ— æ³•è¿æ¥æˆåŠŸçš„æƒ…å†µã€‚
</p>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">é—®é¢˜åˆ†æ</h2>
<div class="outline-text-2" id="text-2">
<p>
åˆæ­¥ä¿¡æ¯è°ƒæŸ¥ï¼š
</p>
<ol class="org-ol">
<li>å®¢æˆ·å¹³å°å†…æ ¸ç‰ˆæœ¬ä¸ºï¼š 3.1.10
</li>
<li>å®æµ‹å‘ç°ï¼Œå½“å¹³å°ä½œGCæ—¶ï¼Œè¿æ¥æ²¡æœ‰é—®é¢˜ã€‚
</li>
<li>åˆ†ææ‰‹æœºç«¯å’Œå¹³å°ç«¯çš„ <code>wpa_supplicant.log</code> ï¼Œæœ‰å¦‚ä¸‹ä¸€äº›å‘ç°ï¼š
<ul class="org-ul">
<li>å¹³å°ç«¯å¦‚ä¸‹Logå¼‚å¸¸ï¼š
<img src="/images/2016/2016031101.png" alt="2016031101.png" />
Associaite Requestä¸­æ²¡æœ‰åŒ…å«RSN IEç­‰ç›¸å…³ä¿¡æ¯ï¼Œè¿™æ˜¯P2Pè¿æ¥è¿‡ç¨‹
ä¸­ï¼Œæ‰€å¿…é¡»ã€‚
</li>
<li>æ‰‹æœºç«¯æœ‰å¦‚ä¸‹Logå¼‚å¸¸ï¼š
<pre class="example">
 03-03 16:06:08.252 I/wpa_supplicant(  864): p2p0: WPS-M2D dev_password_id=0 config_error=12
 03-03 16:06:08.255 D/wpa_supplicant(  864): EAPOL: txSuppRsp
03-03 16:06:08.255 D/wpa_supplicant(  864): TX EAPOL: dst=06:3d:98:a6:29:34
03-03 16:06:08.255 D/wpa_supplicant(  864): TX EAPOL - hexdump(len=78): 01 00 00 4a 02 4d 00 4a fe 00 37 2a 00 00 00 01 02 00 10 4a 00 01 10 10 22 00 01 0d 10 1a 00 10 ...
03-03 16:06:08.256 D/wpa_supplicant(  864): EAPOL: SUPP_BE entering state RECEIVE
03-03 16:06:08.256 D/wpa_supplicant(  864): P2P: Terminate connection due to WPS PBC session overlap
03-03 16:06:08.256 D/wpa_supplicant(  864): P2P: Group Formation failed with 06:3d:98:a6:29:34
03-03 16:06:08.256 D/wpa_supplicant(  864): P2P: Clear timeout (state=PROVISIONING)
03-03 16:06:08.256 D/wpa_supplicant(  864): P2P: State PROVISIONING -&gt; IDLE
03-03 16:06:08.256 I/wpa_supplicant(  864): P2P-GROUP-FORMATION-FAILURE
</pre>
</li>
</ul>
<p>
<code>config_error</code>  çš„å€¼ä¸º 12ï¼Œ å…¶æ„ä¹‰ä¸ºï¼šã€€
<code>WPS_CFG_MULTIPLE_PBC_DETECTED</code> ï¼Œè¿™ä¸ªæ˜¯GOåœ¨å¤„ç†M1ä¿¡æ¯æ—¶ï¼Œå¸¦ä¸Šçš„ã€‚
</p>
</li>
<li>æ ¹æ®åŒæ–¹çš„Logï¼Œ GOåœ¨å¤„ç†GCå‘é€è¿‡æ¥çš„M1æ¶ˆæ¯åï¼Œå›å¤äº†M2Dä¿¡æ¯ç»™GCï¼Œ
ä»è€Œä¸­æ–­äº†WPSçš„äº¤äº’è¿‡ç¨‹ã€‚ä»å¦‚ä¸‹ä»£ç å…¥æ‰‹åˆ†æï¼š


<div class="figure">
<p><img src="/images/2016/2016031102.png" alt="2016031102.png" />
</p>
</div>

<p>
å‡½æ•° <code>wps_registrar_p2p_dev_addr_match</code> ä¸­è¿›è¡Œåœ°å€è¿‡æ»¤æ—¶ï¼Œå‘ç°äº†
çº¿ç´¢ï¼š
</p>


<div class="figure">
<p><img src="/images/2016/2016031103.png" alt="2016031103.png" />
</p>
</div>

<p>
æ­£å¸¸æƒ…å†µä¸‹ï¼Œ <code>reg-&gt;p2p_dev_addr</code> çš„å€¼åº”è¯¥ä¸ <code>wps-&gt;p2p_dev_addr</code>
çš„å€¼ä¸€è‡´ï¼Œä½†æ˜¯ä»å‡ºé”™Logä¸­å‘ç° <code>wps-&gt;p2p_dev_addr</code> çš„å€¼ä¸º0ã€‚  
è€Œ wps ç›¸å…³çš„åˆå§‹åŒ–æ˜¯åœ¨ <code>eap_wsc_init</code> åœ¨è°ƒç”¨äº† <code>wps_init</code> æ¥è¿›
è¡Œåˆå§‹åŒ–çš„ã€‚  å¦‚ä¸‹å›¾æ‰€ç¤º ï¼š
</p>


<div class="figure">
<p><img src="/images/2016/2016031104.png" alt="2016031104.png" />
</p>
</div>

<p>
æœ‰ä¸ªæ¡ä»¶å¼•èµ·æ¥æˆ‘ä»¬çš„æ³¨æ„ï¼š
<code>sm-&gt;assoc_p2p_ie</code>  
æ˜¯å¦å› ä¸ºè¿™ä¸ªä¸ºNULLï¼Œå¯¼è‡´ <code>wps_init</code> åˆå§‹åŒ–æ—¶ï¼Œ <code>p2p_dev_addr</code>  æ²¡æœ‰
å¾—åˆ°èµ‹å€¼ï¼Ÿ
</p>
</li>
<li>åˆ†æ <code>wpa_supplicant</code> å¤„ç†Associate Requestçš„å‡½æ•°ä»£ç ï¼š
åœ¨å‡½æ•° <code>hostapd_notif_assoc</code> é‡Œé¢ï¼Œä¼šè§£æ Associate Request æºå¸¦
çš„IEä¿¡æ¯ï¼Œ ä»£ç å¦‚ä¸‹ï¼š  


<div class="figure">
<p><img src="/images/2016/2016031105.png" alt="2016031105.png" />
</p>
</div>

<p>
å¯ä»¥å‘ç°ï¼Œå¹¶ç»“åˆä¹‹å‰çš„Logå‘ç°ï¼Œ WPSï¼Œ RSNï¼Œ WPAç­‰ IEä¿¡æ¯éƒ½ä¸ºç©ºã€‚
æ‰€ä»¥æœ‰ç†ç”± æ€€ç–‘Driveré€ä¸Šæ¥çš„Associate Requestä¸­å°±æ²¡æœ‰åŒ…å«è¿™äº›IE
ä¿¡æ¯ï¼Œ IEä¿¡æ¯ä¸ºç©ºï¼ï¼ï¼
</p>
</li>
<li>Driverå±‚ç¡®è®¤
 åœ¨Driverå¤„ç†Association Requestçš„åœ°æ–¹ï¼Œ åŠ ä¸€äº›æ‰“å°Logç¡®è®¤æ”¶åˆ°çš„
IEæ˜¯å¦ä¸ºç©ºï¼Œç»“æœå‘ç°ï¼ŒDriveræœ‰æ”¶åˆ°è¿™äº›IEä¿¡æ¯çš„ã€‚ Driveråœ¨å¤„ç†å®Œ
Associate Requeståï¼Œå¦‚æœOKï¼Œä¼šé€å›ä¸€ä¸ªAssociate Responseç»™å¯¹æ–¹
ï¼Œå¹¶è°ƒç”¨ <code>cfg80211_new_sta</code> å°†Associate Requestäº‹ä»¶é€šçŸ¥åˆ°ä¸Šå±‚ã€‚
åº”è¯¥åœ¨è¿™ä¸ªåœ°æ–¹å¯èƒ½å°†IEä¿¡æ¯æ¼æ‰äº†ã€‚ 
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">è§£å†³æ–¹æ³•</h2>
<div class="outline-text-2" id="text-3">
<p>
ç”±äºå®šä½åˆ°é—®é¢˜çš„åŸå› æ˜¯ï¼šé©±åŠ¨åœ¨è°ƒç”¨ <code>cfg80211_new_sta</code> æ—¶ï¼Œæ²¡æœ‰å°† å¦‚
ä¸‹æ ‡è®°è®¾ç½®ï¼š
</p>

<div class="org-src-container">

<pre class="src src-c">struct station_info sinfo;
struct ieee80211_mgmt *mgmt;

NdisZeroMemory(&amp;sinfo, sizeof(sinfo));

//å› ä¸ºè¿™ä¸ªæ ‡è®°æ²¡æœ‰ç½®ä¸Šï¼Œå¯¼è‡´nl80211æ¨¡å—å¤„ç†IEä¿¡æ¯æ—¶ï¼Œ
//å°†assoc_req IEç»™è¿‡æ»¤æ‰äº†, æ­£è§£å°±æ˜¯è¦è®©è¿™å¥æ‰§è¡Œã€‚
 sinfo.filled = STATION_INFO_ASSOC_REQ_IES;

 mgmt = (struct ieee80211_mgmt *) assoc_frame;
 sinfo.assoc_req_ies_len = assoc_len - 24 - 4;
sinfo.assoc_req_ies = mgmt-&gt;u.assoc_req.variable;

return cfg80211_new_sta(pNetDev, mac_addr, &amp;sinfo, GFP_KERNEL);
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Fu Yajun</p>
<p class="date">Created: 2016-03-12 ÖÜÁù 15:15</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.0.50.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
